<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farm-Empire | Investissement Crypto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-active { color: #16a34a; border-top: 3px solid #16a34a; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 pb-20">

    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-600"></div>
    </div>

    <!-- √âcran de Connexion -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-6 bg-green-50">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8">
            <h1 class="text-3xl font-black text-green-700 text-center mb-8">FARM-EMPIRE</h1>
            <div id="login-form">
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Gmail" class="w-full px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-green-500">
                    <input type="password" id="auth-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="handleLogin()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Connexion</button>
                    <p class="text-center text-sm text-gray-600 mt-4">Nouveau ? <button onclick="toggleAuth(false)" class="text-green-600 font-bold">Cr√©er un compte</button></p>
                </div>
            </div>
            <div id="register-form" class="hidden">
                <div class="space-y-4">
                    <input type="text" id="reg-name" placeholder="Nom complet" class="w-full px-4 py-3 rounded-xl border outline-none">
                    <input type="email" id="reg-email" placeholder="Gmail" class="w-full px-4 py-3 rounded-xl border outline-none">
                    <input type="tel" id="reg-phone" placeholder="Num√©ro de t√©l√©phone" class="w-full px-4 py-3 rounded-xl border outline-none">
                    <input type="text" id="reg-parrain" placeholder="Code parrain (optionnel)" class="w-full px-4 py-3 rounded-xl border outline-none">
                    <input type="password" id="reg-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border outline-none">
                    <button onclick="handleRegister()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">S'inscrire</button>
                    <p class="text-center text-sm text-gray-600 mt-4">D√©j√† inscrit ? <button onclick="toggleAuth(true)" class="text-green-600 font-bold">Se connecter</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Application -->
    <div id="app-screen" class="hidden">
        <header class="p-4 flex justify-between items-center glass sticky top-0 z-30">
            <div>
                <h2 class="font-black text-xl text-green-700">Farm-Empire</h2>
                <p id="user-display-name" class="text-xs text-gray-500 font-bold uppercase"></p>
            </div>
            <button onclick="logout()" class="p-2 text-gray-400"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <!-- Onglet Enclos -->
        <main id="tab-enclos" class="tab-content active p-4 space-y-4">
            <div class="bg-gradient-to-br from-green-700 to-green-500 rounded-3xl p-6 text-white shadow-lg">
                <p class="text-sm opacity-80">Solde Disponible</p>
                <h3 class="text-3xl font-black mb-1"><span id="balance-doge">0.00</span> DOGE</h3>
                <p class="text-xs">‚âà <span id="balance-xaf">0</span> FCFA</p>
            </div>
            <div class="flex items-center justify-between px-2 mt-6">
                <h3 class="font-bold text-gray-700"><i class="fas fa-tractor mr-2 text-green-600"></i>Mes Animaux</h3>
            </div>
            <div id="my-farm-list" class="grid grid-cols-1 gap-3"></div>
        </main>

        <!-- Onglet March√© -->
        <main id="tab-market" class="tab-content p-4 space-y-4">
            <div class="grid grid-cols-2 gap-4" id="market-items"></div>
        </main>

        <!-- Onglet Profil -->
        <main id="tab-profile" class="tab-content p-4 space-y-6">
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 grid grid-cols-2 gap-4">
                <button onclick="openDeposit()" class="bg-green-600 text-white p-4 rounded-2xl font-bold shadow-md active:scale-95 transition">
                    <i class="fas fa-plus-circle mb-2 block text-xl"></i> D√©p√¥t
                </button>
                <button onclick="openWithdraw()" class="bg-orange-500 text-white p-4 rounded-2xl font-bold shadow-md active:scale-95 transition">
                    <i class="fas fa-paper-plane mb-2 block text-xl"></i> Retrait
                </button>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <h4 class="font-bold mb-3 text-gray-700">Mon Code Parrain</h4>
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-xl border border-dashed border-green-300">
                    <span class="font-mono font-bold text-green-700 text-lg" id="referral-code">---</span>
                    <button onclick="copyReferral()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold">COPIER</button>
                </div>
                <p class="text-[10px] text-gray-400 mt-2">Gagnez 2% sur chaque d√©p√¥t de vos filleuls.</p>
            </div>

            <div id="admin-access" class="hidden">
                <button onclick="openAdmin()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black shadow-lg">ACC√àS ADMINISTRATEUR</button>
            </div>
        </main>

        <!-- Interface Admin -->
        <main id="tab-admin" class="tab-content p-4 space-y-4 bg-gray-900 min-h-screen text-white fixed inset-0 z-50 overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-green-400">ADMINISTRATION</h2>
                <button onclick="switchTab('profile')" class="text-white text-3xl">&times;</button>
            </div>
            <div id="admin-stats" class="grid grid-cols-2 gap-4 mb-6"></div>
            <h3 class="font-bold border-b border-gray-700 pb-2 text-orange-400">RETRAITS √Ä VALIDER</h3>
            <div id="withdrawal-requests" class="space-y-3 pb-20"></div>
        </main>

        <!-- Barre de Navigation -->
        <nav class="fixed bottom-0 inset-x-0 glass border-t flex justify-around p-2 z-40">
            <button onclick="switchTab('enclos')" class="nav-btn p-2 flex flex-col items-center flex-1 nav-active" id="btn-enclos">
                <i class="fas fa-warehouse text-xl"></i><span class="text-[10px] mt-1 font-bold">ENCLOS</span>
            </button>
            <button onclick="switchTab('market')" class="nav-btn p-2 flex flex-col items-center flex-1 text-gray-400" id="btn-market">
                <i class="fas fa-shopping-cart text-xl"></i><span class="text-[10px] mt-1 font-bold">MARCH√â</span>
            </button>
            <button onclick="switchTab('profile')" class="nav-btn p-2 flex flex-col items-center flex-1 text-gray-400" id="btn-profile">
                <i class="fas fa-user text-xl"></i><span class="text-[10px] mt-1 font-bold">PROFIL</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJzlHhdhC6Vzhet_fJ4vHe30FltBJzOQ4",
            authDomain: "farm-empire-89f3e.firebaseapp.com",
            projectId: "farm-empire-89f3e",
            storageBucket: "farm-empire-89f3e.firebasestorage.app",
            messagingSenderId: "360652511886",
            appId: "1:360652511886:web:2af44776b3fb963d3e47df"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userData = null;
        const DOGE_RATE = 0.014; 
        const DEPOSIT_DOGE = 28.14; 
        const MAKETOU_PUBLIC_LINK = "https://maketou.net/p/41c36b8d-d95e-4faa-92bf-ba389a4d321c"; 

        const animals = [
            { id: 1, name: "Poussin", price: 12.66, daily: 0.84, img: "üê£" },
            { id: 2, name: "Canard", price: 25.00, daily: 1.66, img: "ü¶Ü" },
            { id: 3, name: "Lapin", price: 50.00, daily: 3.33, img: "üêá" },
            { id: 4, name: "Ch√®vre", price: 100.00, daily: 6.66, img: "üêê" },
            { id: 5, name: "Mouton", price: 250.00, daily: 16.66, img: "üêë" },
            { id: 6, name: "Cochon", price: 500.00, daily: 33.33, img: "üêñ" },
            { id: 7, name: "Vache", price: 1000.00, daily: 66.66, img: "üêÑ" },
            { id: 8, name: "Cheval", price: 2500.00, daily: 166.66, img: "üêé" },
            { id: 9, name: "Taureau", price: 5000.00, daily: 333.33, img: "üêÇ" },
            { id: 10, name: "Tracteur Pro", price: 10000.00, daily: 666.66, img: "üöú" }
        ];

        // --- AUTH ---
        window.toggleAuth = (isLogin) => {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (e) { Swal.fire('Erreur', 'Identifiants incorrects', 'error'); }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const parrain = document.getElementById('reg-parrain').value;

            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                const myCode = "FE-" + Math.floor(1000 + Math.random() * 9000);
                await setDoc(doc(db, "users", res.user.uid), {
                    name, email, phone, parrain: parrain || "",
                    myCode, balance: 0, isAdmin: (email === "viva123@gmail.com"),
                    createdAt: serverTimestamp()
                });
            } catch (e) { Swal.fire('Erreur', e.message, 'error'); }
        };

        window.logout = () => signOut(auth);

        // --- NAVIGATION ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-active', 'text-green-600');
                b.classList.add('text-gray-400');
            });
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-${tab}`).classList.add('nav-active', 'text-green-600');
            if (tab === 'market') renderMarket();
            if (tab === 'enclos') renderMyFarm();
            if (tab === 'admin') document.getElementById('tab-admin').classList.remove('hidden');
            else document.getElementById('tab-admin').classList.add('hidden');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userData = snap.data();
                    updateUI();
                });
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
            document.getElementById('loader').classList.add('hidden');
        });

        function updateUI() {
            if (!userData) return;
            document.getElementById('user-display-name').innerText = userData.name;
            document.getElementById('balance-doge').innerText = userData.balance.toFixed(2);
            document.getElementById('balance-xaf').innerText = Math.floor(userData.balance / DOGE_RATE).toLocaleString();
            document.getElementById('referral-code').innerText = userData.myCode;
            if (userData.isAdmin) document.getElementById('admin-access').classList.remove('hidden');
        }

        // --- NOUVELLE M√âTHODE DE D√âP√îT ---
        window.openDeposit = () => {
            Swal.fire({
                title: 'Recharger 2000 FCFA',
                text: "Une fois le paiement effectu√© sur Maketou, envoyez une capture d'√©cran au support pour validation imm√©diate (ou attendez la validation automatique sous 1h).",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Payer sur Maketou',
                confirmButtonColor: '#16a34a'
            }).then((res) => {
                if (res.isConfirmed) {
                    // Ouverture du lien public de produit Maketou
                    window.open(MAKETOU_PUBLIC_LINK, '_blank');
                    
                    // On propose d'entrer le num√©ro de transaction apr√®s le retour
                    setTimeout(() => {
                        Swal.fire({
                            title: 'Paiement effectu√© ?',
                            text: "Si vous avez termin√©, entrez votre num√©ro de t√©l√©phone utilis√© pour le d√©p√¥t.",
                            input: 'text',
                            inputPlaceholder: 'Ex: 077... ou 066...',
                            showCancelButton: true,
                            confirmButtonText: 'Soumettre'
                        }).then(async (result) => {
                            if (result.value) {
                                await addDoc(collection(db, "pending_deposits"), {
                                    userId: auth.currentUser.uid,
                                    userName: userData.name,
                                    phone: result.value,
                                    amount: DEPOSIT_DOGE,
                                    status: 'checking',
                                    timestamp: serverTimestamp()
                                });
                                Swal.fire('Merci', 'Votre d√©p√¥t est en cours de v√©rification par un agent.', 'success');
                            }
                        });
                    }, 2000);
                }
            });
        };

        // --- MARCH√â ET FERME ---
        function renderMarket() {
            const container = document.getElementById('market-items');
            container.innerHTML = animals.map(a => `
                <div class="bg-white p-4 rounded-3xl shadow-sm border flex flex-col items-center">
                    <span class="text-4xl mb-2">${a.img}</span>
                    <h4 class="font-bold text-sm text-gray-800">${a.name}</h4>
                    <p class="text-green-600 font-black mb-1">${a.price} DOGE</p>
                    <p class="text-[10px] text-gray-400 mb-3">${a.daily} DOGE/j</p>
                    <button onclick="buyAnimal(${a.id})" class="w-full bg-green-50 text-green-600 py-2 rounded-xl text-xs font-bold">ACHETER</button>
                </div>
            `).join('');
        }

        window.buyAnimal = async (id) => {
            const a = animals.find(x => x.id === id);
            if (userData.balance < a.price) return Swal.fire('Solde insuffisant', 'Veuillez recharger.', 'warning');
            
            Swal.fire({ title: 'Confirmer', text: `Acheter ${a.name} ?`, showCancelButton: true }).then(async (r) => {
                if (r.isConfirmed) {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-a.price) });
                    await addDoc(collection(db, "users", auth.currentUser.uid, "farm"), {
                        ...a, boughtAt: serverTimestamp(), expiryAt: Date.now() + (30 * 86400000)
                    });
                    Swal.fire('Succ√®s', 'Animal ajout√© !', 'success');
                    switchTab('enclos');
                }
            });
        };

        async function renderMyFarm() {
            const container = document.getElementById('my-farm-list');
            const snap = await getDocs(collection(db, "users", auth.currentUser.uid, "farm"));
            if (snap.empty) {
                container.innerHTML = `<div class="bg-white p-8 rounded-2xl text-center border border-dashed border-gray-200">
                    <p class="text-gray-400 text-sm">Votre enclos est vide.<br>Allez au march√© !</p>
                </div>`;
                return;
            }
            container.innerHTML = snap.docs.map(d => {
                const data = d.data();
                const daysLeft = Math.ceil((data.expiryAt - Date.now()) / 86400000);
                return `<div class="bg-white p-4 rounded-2xl flex items-center justify-between border shadow-sm">
                    <div class="flex items-center space-x-4"><span class="text-3xl">${data.img}</span><div><h4 class="font-bold">${data.name}</h4><p class="text-[10px] text-gray-400">${daysLeft} j restants</p></div></div>
                    <div class="text-right"><p class="text-green-600 font-bold text-xs">+${data.daily} / j</p></div>
                </div>`;
            }).join('');
        }

        // --- RETRAIT & ADMIN ---
        window.openWithdraw = () => {
            if (new Date().getDay() === 0) return Swal.fire('Indisponible', 'Les retraits sont ferm√©s le dimanche.', 'info');
            Swal.fire({
                title: 'Retrait DOGE',
                html: `<input id="wa" class="swal2-input" placeholder="Adresse Portefeuille DOGE"><input id="wm" type="number" class="swal2-input" placeholder="Montant">`,
                preConfirm: () => ({ addr: document.getElementById('wa').value, amount: parseFloat(document.getElementById('wm').value) })
            }).then(async (r) => {
                if (r.isConfirmed) {
                    const { addr, amount } = r.value;
                    if (amount < 5 || userData.balance < amount) return Swal.fire('Erreur', 'Minimum 5 DOGE ou solde insuffisant.', 'error');
                    await addDoc(collection(db, "withdrawals"), {
                        userId: auth.currentUser.uid, userName: userData.name, address: addr, 
                        amount, net: amount * 0.87, status: 'en_attente', createdAt: serverTimestamp()
                    });
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-amount) });
                    Swal.fire('Demande envoy√©e', 'Votre retrait sera valid√© sous 24h.', 'success');
                }
            });
        };

        window.openAdmin = async () => {
            switchTab('admin');
            const uSnap = await getDocs(collection(db, "users"));
            document.getElementById('admin-stats').innerHTML = `
                <div class="bg-gray-800 p-4 rounded-2xl text-center"><p class="text-xs opacity-50">Joueurs</p><p class="text-xl font-bold">${uSnap.size}</p></div>
                <div class="bg-gray-800 p-4 rounded-2xl text-center"><p class="text-xs opacity-50">D√©p√¥ts Attente</p><p id="count-dep" class="text-xl font-bold text-green-400">0</p></div>`;

            // Liste Retraits
            onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "en_attente")), (s) => {
                document.getElementById('withdrawal-requests').innerHTML = s.docs.map(d => `
                    <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700">
                        <p class="text-xs text-gray-400">Client: ${d.data().userName}</p>
                        <p class="text-lg font-bold text-orange-400">${d.data().net.toFixed(2)} DOGE</p>
                        <p class="text-[10px] break-all opacity-50">${d.data().address}</p>
                        <div class="flex gap-2 mt-4">
                            <button onclick="handleAdminW('${d.id}', true)" class="flex-1 bg-green-600 py-2 rounded-xl text-xs font-bold">APPROUVER</button>
                            <button onclick="handleAdminW('${d.id}', false)" class="flex-1 bg-red-600 py-2 rounded-xl text-xs font-bold">REJETER</button>
                        </div>
                    </div>`).join('');
            });

            // Liste D√©p√¥ts √† valider manuellement (Plus fiable pour Maketou)
            onSnapshot(query(collection(db, "pending_deposits"), where("status", "==", "checking")), (s) => {
                document.getElementById('count-dep').innerText = s.size;
                const list = s.docs.map(d => `
                    <div class="bg-green-900/30 p-4 rounded-2xl border border-green-700/50 mt-4">
                        <p class="text-xs">D√©p√¥t d√©clar√© par: ${d.data().userName}</p>
                        <p class="font-bold text-green-400">T√©l: ${d.data().phone}</p>
                        <button onclick="approveDeposit('${d.id}', '${d.data().userId}', ${d.data().amount})" class="w-full bg-green-600 mt-2 py-2 rounded-xl text-xs font-bold">VALIDER LES 28.14 DOGE</button>
                    </div>`).join('');
                document.getElementById('admin-stats').insertAdjacentHTML('afterend', list);
            });
        };

        window.approveDeposit = async (id, uid, amount) => {
            await updateDoc(doc(db, "users", uid), { balance: increment(amount) });
            await updateDoc(doc(db, "pending_deposits", id), { status: 'approved' });
            
            // Commission Parrain 2%
            const u = await getDoc(doc(db, "users", uid));
            if (u.data().parrain) {
                const q = query(collection(db, "users"), where("myCode", "==", u.data().parrain));
                const pS = await getDocs(q);
                if (!pS.empty) await updateDoc(doc(db, "users", pS.docs[0].id), { balance: increment(amount * 0.02) });
            }
            Swal.fire('Valid√©', 'Compte cr√©dit√©', 'success');
        };

        window.handleAdminW = async (id, isApprove) => {
            if (isApprove) await updateDoc(doc(db, "withdrawals", id), { status: 'pay√©' });
            else {
                const s = await getDoc(doc(db, "withdrawals", id));
                await updateDoc(doc(db, "users", s.data().userId), { balance: increment(s.data().amount) });
                await updateDoc(doc(db, "withdrawals", id), { status: 'rejet√©' });
            }
        };

        window.copyReferral = () => {
            navigator.clipboard.writeText(userData.myCode);
            Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Copi√© !', showConfirmButton: false, timer: 1500 });
        };
    </script>
</body>
</html>

