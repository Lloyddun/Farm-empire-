<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farm-Empire | Crypto & Elevage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-active { color: #16a34a; border-top: 3px solid #16a34a; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .loader-spin { border-top-color: #16a34a; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 pb-20">

    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
        <div class="loader-spin rounded-full h-12 w-12 border-4 border-gray-200"></div>
    </div>

    <!-- √âcran de Connexion -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-6 bg-green-50">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8 text-center">
            <h1 class="text-3xl font-black text-green-700 mb-2">FARM-EMPIRE</h1>
            <p class="text-gray-500 text-sm mb-8">Investissez dans l'√©levage num√©rique</p>
            
            <div id="login-form">
                <input type="email" id="auth-email" placeholder="Email" class="w-full px-4 py-3 rounded-xl border mb-4 outline-none focus:ring-2 focus:ring-green-500">
                <input type="password" id="auth-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border mb-6 outline-none">
                <button onclick="handleLogin()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Connexion</button>
                <p class="mt-4 text-sm">Pas de compte ? <button onclick="toggleAuth(false)" class="text-green-600 font-bold">S'inscrire</button></p>
            </div>

            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Nom complet" class="w-full px-4 py-3 rounded-xl border mb-3 outline-none">
                <input type="email" id="reg-email" placeholder="Email" class="w-full px-4 py-3 rounded-xl border mb-3 outline-none">
                <input type="tel" id="reg-phone" placeholder="T√©l√©phone (ex: 077001122)" class="w-full px-4 py-3 rounded-xl border mb-3 outline-none">
                <input type="password" id="reg-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border mb-6 outline-none">
                <button onclick="handleRegister()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">Cr√©er mon compte</button>
                <p class="mt-4 text-sm">D√©j√† inscrit ? <button onclick="toggleAuth(true)" class="text-green-600 font-bold">Se connecter</button></p>
            </div>
        </div>
    </div>

    <!-- Interface Application -->
    <div id="app-screen" class="hidden">
        <header class="p-4 flex justify-between items-center glass sticky top-0 z-30 border-b">
            <h2 class="font-black text-xl text-green-700">Farm-Empire</h2>
            <div class="flex items-center gap-3">
                <span id="user-name" class="text-xs font-bold text-gray-500 uppercase">...</span>
                <button onclick="logout()" class="text-gray-400"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- Mon Enclos -->
        <main id="tab-enclos" class="tab-content active p-4">
            <div class="bg-gradient-to-br from-green-700 to-green-500 rounded-3xl p-6 text-white shadow-lg mb-6">
                <p class="text-sm opacity-80">Solde Disponible</p>
                <h3 class="text-3xl font-black"><span id="balance-doge">0.00</span> DOGE</h3>
                <p class="text-xs">‚âà <span id="balance-xaf">0</span> FCFA</p>
            </div>
            
            <h3 class="font-bold text-gray-700 mb-4"><i class="fas fa-paw mr-2 text-green-600"></i>Mes Animaux</h3>
            <div id="my-farm-list" class="space-y-3"></div>
        </main>

        <!-- March√© -->
        <main id="tab-market" class="tab-content p-4">
            <div class="grid grid-cols-2 gap-4" id="market-list"></div>
        </main>

        <!-- Profil -->
        <main id="tab-profile" class="tab-content p-4 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="initiateDeposit()" class="bg-green-600 text-white p-6 rounded-2xl font-bold flex flex-col items-center">
                    <i class="fas fa-wallet mb-2 text-2xl"></i> D√©p√¥t
                </button>
                <button onclick="handleWithdraw()" class="bg-orange-500 text-white p-6 rounded-2xl font-bold flex flex-col items-center">
                    <i class="fas fa-hand-holding-usd mb-2 text-2xl"></i> Retrait
                </button>
            </div>
            
            <div class="bg-white p-6 rounded-3xl border shadow-sm">
                <p class="text-xs text-gray-400 font-bold mb-1 uppercase tracking-wider">Lien de Parrainage</p>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-dashed border-green-300">
                    <span id="referral-code" class="font-mono font-bold text-green-700">---</span>
                    <button onclick="copyRef()" class="text-green-600 text-xs font-bold">COPIER</button>
                </div>
            </div>

            <div id="admin-section" class="hidden pt-4">
                <button onclick="openAdmin()" class="w-full bg-black text-white py-4 rounded-2xl font-black">PANNEAU ADMIN</button>
            </div>
        </main>

        <!-- Admin View -->
        <div id="admin-modal" class="fixed inset-0 bg-white z-50 p-4 overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">ADMINISTRATION</h2>
                <button onclick="closeAdmin()" class="text-3xl">&times;</button>
            </div>
            <div id="admin-stats" class="grid grid-cols-2 gap-4 mb-8 text-center"></div>
            <h3 class="font-bold border-b pb-2 mb-4">Retraits en attente</h3>
            <div id="admin-withdrawals" class="space-y-3"></div>
        </div>

        <!-- Navigation -->
        <nav class="fixed bottom-0 inset-x-0 glass border-t flex justify-around p-3 z-40">
            <button onclick="switchTab('enclos')" id="btn-enclos" class="nav-active flex flex-col items-center">
                <i class="fas fa-home text-xl"></i><span class="text-[10px] mt-1 font-bold uppercase">Enclos</span>
            </button>
            <button onclick="switchTab('market')" id="btn-market" class="text-gray-400 flex flex-col items-center">
                <i class="fas fa-store text-xl"></i><span class="text-[10px] mt-1 font-bold uppercase">March√©</span>
            </button>
            <button onclick="switchTab('profile')" id="btn-profile" class="text-gray-400 flex flex-col items-center">
                <i class="fas fa-user-circle text-xl"></i><span class="text-[10px] mt-1 font-bold uppercase">Profil</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, increment, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJzlHhdhC6Vzhet_fJ4vHe30FltBJzOQ4",
            authDomain: "farm-empire-89f3e.firebaseapp.com",
            projectId: "farm-empire-89f3e",
            storageBucket: "farm-empire-89f3e.firebasestorage.app",
            messagingSenderId: "360652511886",
            appId: "1:360652511886:web:2af44776b3fb963d3e47df"
        };

        const MAKETOU = {
            apiKey: 'msk_35395609d94589dfe55e846950480c47fb9f44af58f590faf6ab2bbe0a0c2014',
            productId: '0bdd242d-3ae3-4640-816e-97a5e731796b',
            apiUrl: 'https://api.maketou.net/api/v1/stores/cart'
        };

        const DOGE_XAF = 0.014; // 1 DOGE ‚âà 71 FCFA (2000 FCFA = ~28 DOGE)

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;

        const animals = [
            { id: 1, name: "Poussin", price: 10, daily: 0.8, icon: "üê£" },
            { id: 2, name: "Canard", price: 25, daily: 2.1, icon: "ü¶Ü" },
            { id: 3, name: "Mouton", price: 100, daily: 8.5, icon: "üêë" },
            { id: 4, name: "Vache", price: 500, daily: 45, icon: "üêÑ" }
        ];

        // --- AUTH LOGIC ---
        window.toggleAuth = (isLogin) => {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch (e) { Swal.fire('Erreur', 'Identifiants incorrects', 'error'); }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-password').value;

            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                const code = "FE-" + Math.floor(Math.random()*9000 + 1000);
                await setDoc(doc(db, "users", res.user.uid), {
                    name, email, phone, balance: 0, code, isAdmin: email === "viva123@gmail.com",
                    createdAt: serverTimestamp()
                });
            } catch (e) { Swal.fire('Erreur', e.message, 'error'); }
        };

        window.logout = () => signOut(auth);

        // --- NAVIGATION ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-green-600', 'text-gray-400'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`btn-${tab}`).classList.replace('text-gray-400', 'text-green-600');
            if(tab === 'market') renderMarket();
            if(tab === 'enclos') renderEnclos();
        };

        // --- CORE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userData = snap.data();
                    updateUI();
                });
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                checkPaymentCallback(); // V√©rifie si on revient d'un paiement
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
            document.getElementById('loader').classList.add('hidden');
        });

        function updateUI() {
            if(!userData) return;
            document.getElementById('user-name').innerText = userData.name;
            document.getElementById('balance-doge').innerText = userData.balance.toFixed(2);
            document.getElementById('balance-xaf').innerText = Math.floor(userData.balance / DOGE_XAF).toLocaleString();
            document.getElementById('referral-code').innerText = userData.code;
            if(userData.isAdmin) document.getElementById('admin-section').classList.remove('hidden');
        }

        // --- PAIEMENT MAKETOU (COMME GABONJOB) ---
        window.initiateDeposit = async () => {
            Swal.fire({
                title: 'Recharger 2000 FCFA',
                text: "Vous allez √™tre redirig√© vers Maketou pour le paiement.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Proc√©der',
                confirmButtonColor: '#16a34a'
            }).then(async (res) => {
                if(res.isConfirmed) {
                    Swal.fire({ title: 'Chargement...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    
                    try {
                        const payload = {
                            productDocumentId: MAKETOU.productId,
                            email: userData.email,
                            firstName: userData.name.split(' ')[0],
                            lastName: userData.name.split(' ')[1] || 'User',
                            phone: userData.phone,
                            redirectURL: window.location.href // Revient ici apr√®s le paiement
                        };

                        const response = await fetch(`${MAKETOU.apiUrl}/checkout`, {
                            method: 'POST',
                            headers: { 
                                'Authorization': `Bearer ${MAKETOU.apiKey}`,
                                'Content-Type': 'application/json' 
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();
                        if(data.redirectUrl) {
                            // Sauvegarde de la session de paiement
                            localStorage.setItem('pending_cart', data.cartId);
                            window.location.href = data.redirectUrl;
                        } else {
                            throw new Error(data.message || "Erreur de connexion Maketou");
                        }
                    } catch (err) {
                        Swal.fire('Erreur', err.message, 'error');
                    }
                }
            });
        };

        // V√©rification automatique au retour de Maketou
        async function checkPaymentCallback() {
            const cartId = localStorage.getItem('pending_cart');
            if(!cartId) return;

            try {
                const response = await fetch(`${MAKETOU.apiUrl}/${cartId}`, {
                    headers: { 'Authorization': `Bearer ${MAKETOU.apiKey}` }
                });
                const data = await response.json();

                if(data.status === 'completed' || data.status === 'success') {
                    // On cr√©dite les 28 DOGE (2000 FCFA)
                    await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(28.14) });
                    Swal.fire('Bravo !', 'Votre compte a √©t√© cr√©dit√© de 28.14 DOGE', 'success');
                }
            } catch (e) { console.error("Verif Error:", e); }
            localStorage.removeItem('pending_cart');
        }

        // --- GAME LOGIC ---
        function renderMarket() {
            const list = document.getElementById('market-list');
            list.innerHTML = animals.map(a => `
                <div class="bg-white p-4 rounded-3xl shadow-sm border text-center">
                    <span class="text-4xl block mb-2">${a.icon}</span>
                    <h4 class="font-bold">${a.name}</h4>
                    <p class="text-green-600 font-black">${a.price} DOGE</p>
                    <p class="text-[10px] text-gray-400 mb-3">${a.daily} DOGE / jour</p>
                    <button onclick="buyAnimal(${a.id})" class="w-full bg-green-50 text-green-600 py-2 rounded-xl text-xs font-bold uppercase">Acheter</button>
                </div>
            `).join('');
        }

        window.buyAnimal = async (id) => {
            const animal = animals.find(a => a.id === id);
            if(userData.balance < animal.price) return Swal.fire('Oups', 'Solde insuffisant', 'warning');

            await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(-animal.price) });
            await addDoc(collection(db, "users", currentUser.uid, "farm"), {
                ...animal, date: serverTimestamp()
            });
            Swal.fire('F√©licitations', `${animal.name} a rejoint votre enclos !`, 'success');
            switchTab('enclos');
        };

        async function renderEnclos() {
            const snap = await getDocs(collection(db, "users", currentUser.uid, "farm"));
            const list = document.getElementById('my-farm-list');
            if(snap.empty) {
                list.innerHTML = `<p class="text-center text-gray-400 py-10">Aucun animal. Visitez le march√© !</p>`;
                return;
            }
            list.innerHTML = snap.docs.map(doc => {
                const a = doc.data();
                return `
                <div class="bg-white p-4 rounded-2xl flex items-center justify-between border shadow-sm">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">${a.icon}</span>
                        <div><h4 class="font-bold text-sm">${a.name}</h4><p class="text-[10px] text-gray-400">Production active</p></div>
                    </div>
                    <div class="text-right">
                        <p class="text-green-600 font-bold text-xs">+${a.daily} DOGE/j</p>
                    </div>
                </div>`;
            }).join('');
        }

        window.handleWithdraw = () => {
            Swal.fire({
                title: 'Demande de retrait',
                input: 'number',
                inputPlaceholder: 'Montant en DOGE (min 10)',
                showCancelButton: true
            }).then(async (res) => {
                if(res.value && res.value >= 10) {
                    if(userData.balance < res.value) return Swal.fire('Erreur', 'Solde insuffisant', 'error');
                    await addDoc(collection(db, "withdrawals"), {
                        userId: currentUser.uid, name: userData.name, amount: res.value, status: 'en_attente', date: serverTimestamp()
                    });
                    await updateDoc(doc(db, "users", currentUser.uid), { balance: increment(-res.value) });
                    Swal.fire('R√©ussi', 'Votre demande sera trait√©e sous 24h', 'success');
                }
            });
        };

        // --- ADMIN ---
        window.openAdmin = async () => {
            document.getElementById('admin-modal').classList.remove('hidden');
            const uSnap = await getDocs(collection(db, "users"));
            document.getElementById('admin-stats').innerHTML = `
                <div class="bg-gray-100 p-4 rounded-2xl"><p class="text-xs opacity-50">Joueurs</p><p class="text-xl font-bold">${uSnap.size}</p></div>
                <div class="bg-gray-100 p-4 rounded-2xl"><p class="text-xs opacity-50">Solde Total</p><p class="text-xl font-bold text-green-600">...</p></div>`;
            
            onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "en_attente")), (snap) => {
                document.getElementById('admin-withdrawals').innerHTML = snap.docs.map(d => `
                    <div class="bg-gray-50 p-4 rounded-xl flex justify-between items-center border">
                        <div><p class="font-bold">${d.data().name}</p><p class="text-orange-500 font-black">${d.data().amount} DOGE</p></div>
                        <button onclick="approveW('${d.id}')" class="bg-black text-white px-4 py-2 rounded-lg text-xs">PAYER</button>
                    </div>`).join('');
            });
        };
        window.closeAdmin = () => document.getElementById('admin-modal').classList.add('hidden');
        window.approveW = async (id) => {
            await updateDoc(doc(db, "withdrawals", id), { status: 'pay√©' });
            Swal.fire('Fait', 'Retrait marqu√© comme pay√©', 'success');
        };
        window.copyRef = () => { navigator.clipboard.writeText(userData.code); Swal.fire('Copi√©','','success'); };
    </script>
</body>
</html>

