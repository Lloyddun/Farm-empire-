<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farm-Empire | Service d'Élevage Crypto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            green: '#059669',
                            gold: '#fbbf24',
                            dark: '#0f172a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .page.active { display: block; }
        .loader { border-top-color: #059669; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <header class="glass fixed top-0 w-full z-50 border-b px-5 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2" onclick="window.location.reload()">
            <div class="w-8 h-8 bg-brand-green rounded-lg flex items-center justify-center text-white font-extrabold text-sm">FE</div>
            <span class="font-extrabold text-lg tracking-tighter">FARM-EMPIRE</span>
        </div>
        <div id="user-info" class="hidden flex items-center gap-3">
            <span id="user-name" class="text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full text-slate-600">...</span>
            <button onclick="window.app.logout()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main id="content" class="pt-24 px-5 max-w-lg mx-auto">
        
        <!-- SECTION : AUTH -->
        <section id="page-auth" class="page active">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-extrabold text-slate-900 mb-2">Connexion</h1>
                <p class="text-slate-500">Accédez à votre compte de minage DOGE.</p>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <form id="form-login" onsubmit="window.app.handleAuth(event)" class="space-y-4">
                    <div id="auth-status" class="text-[10px] text-center font-bold text-amber-600 bg-amber-50 py-2 rounded-xl mb-2">
                        <i class="fas fa-shield-alt mr-1"></i> Synchronisation avec le réseau...
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Email</label>
                        <input type="email" id="auth-email" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-brand-green/20" placeholder="exemple@mail.com" required>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Mot de passe</label>
                        <input type="password" id="auth-password" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-brand-green/20" placeholder="••••••••" required>
                    </div>
                    <button type="submit" id="btn-auth" disabled class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">
                        Veuillez patienter...
                    </button>
                </form>
            </div>
        </section>

        <!-- SECTION : DASHBOARD -->
        <section id="page-dashboard" class="page">
            <div id="status-inactive" class="hidden">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 text-center mb-6">
                    <div class="w-20 h-20 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center text-3xl mx-auto mb-6">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2 class="text-2xl font-extrabold mb-3">Enclos Inactif</h2>
                    <p class="text-slate-500 mb-8 leading-relaxed">Activez votre service pour générer des **DOGE**.</p>
                    
                    <button onclick="window.app.activateService()" id="btn-pay" class="w-full bg-brand-green text-white font-black py-5 rounded-2xl shadow-xl flex justify-between items-center px-8 active:scale-95 transition">
                        <span>ACTIVER L'ENCLOS</span>
                        <span class="bg-white/20 px-3 py-1 rounded-lg text-sm">2 000 FCFA</span>
                    </button>
                </div>
            </div>

            <div id="status-active" class="hidden">
                <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl mb-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 mb-6">
                            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                            <span class="text-[10px] font-bold tracking-widest uppercase opacity-60">Production en cours</span>
                        </div>
                        <p class="text-xs font-bold opacity-50 uppercase mb-1">Solde actuel</p>
                        <h3 class="text-5xl font-black mb-4"><span id="balance-val">0.00</span> <span class="text-brand-gold text-2xl">DOGE</span></h3>
                        <button onclick="window.app.withdraw()" class="w-full bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm transition">Retirer mes gains</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION : PENDING -->
        <section id="page-pending" class="page text-center pt-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-16 w-16 mb-6 mx-auto"></div>
            <h2 class="text-xl font-bold mb-2">Traitement...</h2>
            <p class="text-slate-400">Vérification de la transaction.</p>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'farm-empire-89f3e';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        const AppManager = {
            user: null,
            userId: null,
            isAuthReady: false,

            init: async function() {
                // Authentification obligatoire avant toute chose
                try {
                    if (initialToken) {
                        await signInWithCustomToken(auth, initialToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Auth Error:", e);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.isAuthReady = true;
                        this.updateAuthUI();
                        // Reconnexion automatique si email présent
                        const savedEmail = localStorage.getItem('fe_email');
                        if (savedEmail) this.autoLogin(savedEmail);
                    }
                });
            },

            updateAuthUI: function() {
                const btn = document.getElementById('btn-auth');
                const status = document.getElementById('auth-status');
                if (btn) {
                    btn.disabled = false;
                    btn.innerText = "Accéder à l'enclos";
                }
                if (status) {
                    status.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i> Réseau prêt';
                    status.className = "text-[10px] text-center font-bold text-green-600 bg-green-50 py-2 rounded-xl mb-2";
                }
            },

            // RÈGLE 1 : Utilisation du dossier public pour permettre l'accès par email
            getDocRef: function(email) {
                const safeId = btoa(email).replace(/[^a-zA-Z0-9]/g, '');
                return doc(db, 'artifacts', appId, 'public', 'data', 'users', safeId);
            },

            handleAuth: async function(e) {
                e.preventDefault();
                if (!this.isAuthReady) return;

                const email = document.getElementById('auth-email').value.toLowerCase().trim();
                const pass = document.getElementById('auth-password').value;
                const btn = document.getElementById('btn-auth');
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';

                try {
                    const docRef = this.getDocRef(email);
                    const snap = await getDoc(docRef);

                    if (!snap.exists()) {
                        // Création de compte
                        const newUser = {
                            email,
                            password: pass,
                            name: email.split('@')[0],
                            balance: 0,
                            isActive: false,
                            createdAt: serverTimestamp()
                        };
                        await setDoc(docRef, newUser);
                        this.user = newUser;
                    } else {
                        // Connexion
                        const data = snap.data();
                        if (data.password !== pass) {
                            alert("Mot de passe incorrect.");
                            btn.disabled = false;
                            btn.innerText = "Accéder à l'enclos";
                            return;
                        }
                        this.user = data;
                    }

                    localStorage.setItem('fe_email', email);
                    this.startListener(email);
                } catch (err) {
                    console.error("Firestore Error:", err);
                    alert("Erreur de connexion au serveur. Vérifiez votre connexion.");
                    btn.disabled = false;
                    btn.innerText = "Accéder à l'enclos";
                }
            },

            autoLogin: function(email) {
                this.startListener(email);
            },

            startListener: function(email) {
                const docRef = this.getDocRef(email);
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        this.user = snap.data();
                        this.updateDashboard();
                        this.navigate('dashboard');
                    }
                }, (err) => {
                    console.error("Snapshot Error:", err);
                });
            },

            updateDashboard: function() {
                const info = document.getElementById('user-info');
                const name = document.getElementById('user-name');
                const activeSec = document.getElementById('status-active');
                const inactiveSec = document.getElementById('status-inactive');
                const bal = document.getElementById('balance-val');

                if (info) info.classList.remove('hidden');
                if (name) name.innerText = this.user.name;

                if (this.user.isActive) {
                    activeSec.classList.remove('hidden');
                    inactiveSec.classList.add('hidden');
                    bal.innerText = (this.user.balance || 0).toFixed(2);
                } else {
                    activeSec.classList.add('hidden');
                    inactiveSec.classList.remove('hidden');
                }
            },

            navigate: function(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${id}`).classList.add('active');
            },

            logout: function() {
                localStorage.clear();
                window.location.reload();
            },

            withdraw: function() {
                alert("Solde insuffisant pour un retrait (minimum 50 DOGE).");
            }
        };

        window.app = AppManager;
        AppManager.init();
    </script>
</body>
</html>