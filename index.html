<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Farm-Empire | Investissement Crypto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-active { color: #16a34a; border-top: 3px solid #16a34a; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        /* Emp√™cher le d√©filement horizontal */
        html, body { width: 100%; position: relative; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 pb-20">

    <!-- Chargement -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-green-600"></div>
    </div>

    <!-- Authentification -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-6 bg-green-50">
        <div class="w-full max-w-md bg-white rounded-3xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-green-700">FARM-EMPIRE</h1>
                <p class="text-gray-500 text-sm">G√©rez votre ferme crypto</p>
            </div>

            <div id="login-form">
                <div class="space-y-4">
                    <input type="email" id="auth-email" placeholder="Gmail" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="password" id="auth-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="handleLogin()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">Connexion</button>
                    <p class="text-center text-sm text-gray-600">Nouveau ? <button onclick="toggleAuth(false)" class="text-green-600 font-bold">Cr√©er un compte</button></p>
                </div>
            </div>

            <div id="register-form" class="hidden">
                <div class="space-y-4">
                    <input type="text" id="reg-name" placeholder="Nom complet" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="email" id="reg-email" placeholder="Gmail" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="tel" id="reg-phone" placeholder="Num√©ro" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="reg-parrain" placeholder="Code parrain" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="password" id="reg-password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="handleRegister()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">S'inscrire</button>
                    <p class="text-center text-sm text-gray-600">D√©j√† inscrit ? <button onclick="toggleAuth(true)" class="text-green-600 font-bold">Se connecter</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Principale -->
    <div id="app-screen" class="hidden">
        <!-- Header -->
        <header class="p-4 flex justify-between items-center glass sticky top-0 z-30">
            <div>
                <h2 class="font-black text-xl text-green-700">Farm-Empire</h2>
                <p id="user-display-name" class="text-xs text-gray-500 uppercase tracking-widest font-bold"></p>
            </div>
            <button onclick="logout()" class="p-2 text-gray-400"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <!-- Vue Enclos -->
        <main id="tab-enclos" class="tab-content active p-4 space-y-4">
            <div class="bg-gradient-to-r from-green-600 to-green-500 rounded-3xl p-6 text-white shadow-lg">
                <p class="text-sm opacity-80">Solde Total</p>
                <h3 class="text-3xl font-black mb-1"><span id="balance-doge">0.00</span> DOGE</h3>
                <p class="text-xs">‚âà <span id="balance-xaf">0</span> XAF</p>
            </div>

            <h3 class="font-bold text-gray-700 mt-6"><i class="fas fa-tractor mr-2"></i>Mes Animaux</h3>
            <div id="my-farm-list" class="grid grid-cols-1 gap-3">
                <!-- Animaux achet√©s ici -->
            </div>
        </main>

        <!-- Vue March√© -->
        <main id="tab-market" class="tab-content p-4 space-y-4">
            <div class="grid grid-cols-2 gap-4" id="market-items">
                <!-- Items de la ferme inject√©s par JS -->
            </div>
        </main>

        <!-- Vue Profil -->
        <main id="tab-profile" class="tab-content p-4 space-y-6">
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <div class="flex items-center space-x-4 mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-2xl flex items-center justify-center text-green-600 text-2xl">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div>
                        <h4 id="profile-name" class="font-bold text-lg">---</h4>
                        <p id="profile-email" class="text-sm text-gray-500">---</p>
                        <p class="text-xs font-mono text-gray-400">ID: <span id="profile-uid">---</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openDeposit()" class="bg-green-600 text-white p-4 rounded-2xl font-bold shadow-md"><i class="fas fa-plus-circle mb-2 block text-xl"></i> D√©p√¥t</button>
                    <button onclick="openWithdraw()" class="bg-orange-500 text-white p-4 rounded-2xl font-bold shadow-md"><i class="fas fa-paper-plane mb-2 block text-xl"></i> Retrait</button>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                <h4 class="font-bold mb-4">Parrainage (2%)</h4>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-dashed">
                    <span class="font-mono font-bold text-green-700" id="referral-code">---</span>
                    <button onclick="copyReferral()" class="text-sm text-gray-400"><i class="fas fa-copy"></i> Copier</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Filleuls actifs: <span id="active-referrals">0</span></p>
            </div>

            <div id="admin-access" class="hidden">
                <button onclick="openAdmin()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-black shadow-lg">ESPACE ADMINISTRATEUR</button>
            </div>
        </main>

        <!-- Vue Admin -->
        <main id="tab-admin" class="tab-content p-4 space-y-4 bg-gray-900 min-h-screen text-white fixed inset-0 z-50 overflow-y-auto hidden">
            <div class="flex justify-between items-center mb-6 p-4">
                <h2 class="text-2xl font-black text-green-400">ADMIN PANEL</h2>
                <button onclick="switchTab('profile')" class="text-red-400 font-bold">X</button>
            </div>
            <div class="p-4 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800 p-4 rounded-2xl">
                        <p class="text-xs opacity-50 uppercase">Utilisateurs</p>
                        <p class="text-2xl font-bold" id="admin-total-users">0</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-2xl">
                        <p class="text-xs opacity-50 uppercase">Tr√©sorerie (FCFA)</p>
                        <p class="text-2xl font-bold text-green-400" id="admin-total-cash">0</p>
                    </div>
                </div>
                <h3 class="font-bold border-b border-gray-700 pb-2">DEMANDES DE RETRAIT</h3>
                <div id="withdrawal-requests" class="space-y-3"></div>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="fixed bottom-0 inset-x-0 glass border-t flex justify-around p-2 z-40">
            <button onclick="switchTab('enclos')" class="nav-btn p-2 flex flex-col items-center flex-1 nav-active" id="btn-enclos">
                <i class="fas fa-warehouse text-xl"></i>
                <span class="text-[10px] uppercase mt-1">Enclos</span>
            </button>
            <button onclick="switchTab('market')" class="nav-btn p-2 flex flex-col items-center flex-1 text-gray-400" id="btn-market">
                <i class="fas fa-shopping-cart text-xl"></i>
                <span class="text-[10px] uppercase mt-1">March√©</span>
            </button>
            <button onclick="switchTab('profile')" class="nav-btn p-2 flex flex-col items-center flex-1 text-gray-400" id="btn-profile">
                <i class="fas fa-user text-xl"></i>
                <span class="text-[10px] uppercase mt-1">Profil</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, onSnapshot, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJzlHhdhC6Vzhet_fJ4vHe30FltBJzOQ4",
            authDomain: "farm-empire-89f3e.firebaseapp.com",
            projectId: "farm-empire-89f3e",
            storageBucket: "farm-empire-89f3e.firebasestorage.app",
            messagingSenderId: "360652511886",
            appId: "1:360652511886:web:2af44776b3fb963d3e47df"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userData = null;
        const DOGE_RATE = 0.014;
        const DEPOSIT_DOGE = 28.14; // ‚âà 2000 FCFA
        const MAKETOU_API_KEY = "msk_74de5315e1f3bf8c624eace9a84ee7883471e2fdfeef1a84fca3c066adc46ac4";
        const MAKETOU_PRODUCT_ID = "41c36b8d-d95e-4faa-92bf-ba389a4d321c";

        const animals = [
            { id: 1, name: "Poussin", price: 12.66, daily: 0.84, img: "üê£" },
            { id: 2, name: "Canard", price: 25.00, daily: 1.66, img: "ü¶Ü" },
            { id: 3, name: "Lapin", price: 50.00, daily: 3.33, img: "üêá" },
            { id: 4, name: "Ch√®vre", price: 100.00, daily: 6.66, img: "üêê" },
            { id: 5, name: "Mouton", price: 250.00, daily: 16.66, img: "üêë" },
            { id: 6, name: "Cochon", price: 500.00, daily: 33.33, img: "üêñ" },
            { id: 7, name: "Vache", price: 1000.00, daily: 66.66, img: "üêÑ" },
            { id: 8, name: "Cheval", price: 2500.00, daily: 166.66, img: "üêé" },
            { id: 9, name: "Taureau", price: 5000.00, daily: 333.33, img: "üêÇ" },
            { id: 10, name: "Tracteur Pro", price: 10000.00, daily: 666.66, img: "üöú" }
        ];

        window.toggleAuth = (isLogin) => {
            document.getElementById('login-form').classList.toggle('hidden', !isLogin);
            document.getElementById('register-form').classList.toggle('hidden', isLogin);
        };

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            if(!email || !pass) return Swal.fire('Attention', 'Veuillez remplir les champs.', 'warning');
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                Swal.fire('Erreur', 'Identifiants invalides.', 'error');
            }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const parrain = document.getElementById('reg-parrain').value;

            if(!email || !pass || !name || !phone) return Swal.fire('Attention', 'Champs obligatoires manquants.', 'warning');

            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                const uid = res.user.uid;
                const myCode = "FE-" + Math.floor(1000 + Math.random() * 9000);
                
                await setDoc(doc(db, "users", uid), {
                    name, email, phone, parrain: parrain || "",
                    myCode,
                    balance: 0,
                    isAdmin: (email.toLowerCase() === "viva123@gmail.com"),
                    createdAt: serverTimestamp()
                });
            } catch (e) {
                Swal.fire('Erreur', 'Inscription √©chou√©e : ' + e.message, 'error');
            }
        };

        window.logout = () => signOut(auth);

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-active', 'text-green-600');
                b.classList.add('text-gray-400');
            });
            
            const target = document.getElementById(`tab-${tab}`);
            const btn = document.getElementById(`btn-${tab}`);
            if(target) target.classList.add('active');
            if(btn) btn.classList.add('nav-active', 'text-green-600');
            
            if (tab === 'market') renderMarket();
            if (tab === 'enclos') renderMyFarm();
            if (tab === 'admin') document.getElementById('tab-admin').classList.remove('hidden');
            else document.getElementById('tab-admin').classList.add('hidden');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userData = snap.data();
                    updateUI();
                });
                checkPaymentCallback();
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
            document.getElementById('loader').classList.add('hidden');
        });

        async function checkPaymentCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const cartId = urlParams.get('cartId');

            if (status === 'success' && cartId) {
                const docRef = doc(db, "deposits", cartId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    await setDoc(docRef, { userId: auth.currentUser.uid, amount: DEPOSIT_DOGE, date: serverTimestamp() });
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(DEPOSIT_DOGE) });
                    
                    // Bonus parrainage 2%
                    if (userData && userData.parrain) {
                        const qP = query(collection(db, "users"), where("myCode", "==", userData.parrain));
                        const sP = await getDocs(qP);
                        if (!sP.empty) {
                            await updateDoc(doc(db, "users", sP.docs[0].id), { balance: increment(DEPOSIT_DOGE * 0.02) });
                        }
                    }
                    Swal.fire('Succ√®s !', 'D√©p√¥t de 28.14 DOGE valid√©.', 'success');
                }
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function updateUI() {
            if (!userData) return;
            document.getElementById('user-display-name').innerText = userData.name;
            document.getElementById('balance-doge').innerText = userData.balance.toFixed(2);
            document.getElementById('balance-xaf').innerText = Math.floor(userData.balance / DOGE_RATE).toLocaleString();
            document.getElementById('profile-name').innerText = userData.name;
            document.getElementById('profile-email').innerText = userData.email;
            document.getElementById('profile-uid').innerText = auth.currentUser.uid;
            document.getElementById('referral-code').innerText = userData.myCode;
            if (userData.isAdmin) document.getElementById('admin-access').classList.remove('hidden');
        }

        function renderMarket() {
            const container = document.getElementById('market-items');
            container.innerHTML = animals.map(a => `
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center">
                    <span class="text-4xl mb-2">${a.img}</span>
                    <h4 class="font-bold text-sm text-gray-800">${a.name}</h4>
                    <p class="text-green-600 font-black mb-1">${a.price} DOGE</p>
                    <p class="text-[10px] text-gray-400 mb-3">Revenu: ${a.daily} DOGE/j</p>
                    <button onclick="buyAnimal(${a.id})" class="w-full bg-green-50 text-green-600 py-2 rounded-xl text-xs font-bold active:bg-green-600 active:text-white transition">ACHETER</button>
                </div>
            `).join('');
        }

        window.buyAnimal = async (id) => {
            const animal = animals.find(a => a.id === id);
            if (userData.balance < animal.price) return Swal.fire('Oups', 'Solde insuffisant.', 'warning');
            
            Swal.fire({ 
                title: 'Confirmer', 
                text: `Acheter un ${animal.name} pour ${animal.price} DOGE ?`, 
                showCancelButton: true,
                confirmButtonColor: '#16a34a'
            }).then(async (res) => {
                if (res.isConfirmed) {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-animal.price) });
                    await addDoc(collection(db, "users", auth.currentUser.uid, "farm"), { 
                        ...animal, 
                        boughtAt: serverTimestamp(), 
                        expiryAt: Date.now() + (30 * 24 * 60 * 60 * 1000) 
                    });
                    Swal.fire('F√©licitations', 'Production d√©marr√©e !', 'success');
                    switchTab('enclos');
                }
            });
        };

        async function renderMyFarm() {
            const container = document.getElementById('my-farm-list');
            const snap = await getDocs(collection(db, "users", auth.currentUser.uid, "farm"));
            if (snap.empty) {
                container.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">Aucun animal actif.</div>`;
                return;
            }
            container.innerHTML = snap.docs.map(d => {
                const data = d.data();
                const days = Math.max(0, Math.ceil((data.expiryAt - Date.now()) / 86400000));
                return `<div class="bg-white p-4 rounded-2xl flex items-center justify-between border shadow-sm">
                    <div class="flex items-center space-x-4"><span class="text-3xl">${data.img}</span><div><h4 class="font-bold text-gray-800">${data.name}</h4><p class="text-[10px] text-gray-500">${days} jours restants</p></div></div>
                    <div class="text-right"><p class="text-green-600 font-bold text-xs">+${data.daily} DOGE/j</p></div>
                </div>`;
            }).join('');
        }

        // --- GESTION DU D√âP√îT MAKETOU ---
        window.openDeposit = async () => {
            if(!userData) return;
            Swal.fire({
                title: 'D√©p√¥t 2000 FCFA',
                text: "Vous allez √™tre redirig√© vers le portail Mobile Money.",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Continuer',
                confirmButtonColor: '#16a34a'
            }).then(async (res) => {
                if (res.isConfirmed) {
                    Swal.fire({ title: 'Redirection...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    
                    try {
                        const payload = {
                            productDocumentId: MAKETOU_PRODUCT_ID,
                            email: userData.email,
                            firstName: userData.name,
                            lastName: "FE-Client",
                            phone: userData.phone,
                            // Utilisation de l'origine actuelle pour le retour
                            redirectURL: window.location.origin + window.location.pathname + "?status=success",
                            meta: { userId: auth.currentUser.uid }
                        };

                        const response = await fetch("https://api.maketou.net/api/v1/stores/cart/checkout", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${MAKETOU_API_KEY}`
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();
                        if (data.redirectUrl) {
                            window.location.href = data.redirectUrl;
                        } else {
                            throw new Error("Lien de paiement invalide.");
                        }
                    } catch (e) {
                        Swal.fire('Erreur API', "Impossible d'initier le paiement. R√©essayez.", 'error');
                    }
                }
            });
        };

        window.openWithdraw = () => {
            if (new Date().getDay() === 0) return Swal.fire('Pause', 'Les retraits sont ferm√©s le Dimanche.', 'info');
            Swal.fire({
                title: 'Retrait DOGE',
                html: `<input id="w-addr" class="swal2-input" placeholder="Adresse Portefeuille DOGE"><input id="w-amount" type="number" class="swal2-input" placeholder="Montant">`,
                preConfirm: () => ({ addr: document.getElementById('w-addr').value, amount: parseFloat(document.getElementById('w-amount').value) })
            }).then(async (res) => {
                if (res.isConfirmed) {
                    const { addr, amount } = res.value;
                    if (!addr || amount < 5) return Swal.fire('Erreur', 'Minimum 5 DOGE.', 'error');
                    if (userData.balance < amount) return Swal.fire('Solde insuffisant', '', 'error');
                    
                    await addDoc(collection(db, "withdrawals"), { 
                        userId: auth.currentUser.uid, 
                        userName: userData.name, 
                        address: addr, 
                        amountRequested: amount, 
                        netAmount: amount * 0.87, 
                        status: 'en_attente', 
                        createdAt: serverTimestamp() 
                    });
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-amount) });
                    Swal.fire('R√©ussi', 'Demande en cours de traitement.', 'success');
                }
            });
        };

        window.openAdmin = async () => {
            switchTab('admin');
            const uS = await getDocs(collection(db, "users"));
            document.getElementById('admin-total-users').innerText = uS.size;
            let cash = 0; uS.forEach(u => cash += (u.data().balance / DOGE_RATE));
            document.getElementById('admin-total-cash').innerText = Math.floor(cash).toLocaleString();
            
            onSnapshot(query(collection(db, "withdrawals"), where("status", "==", "en_attente")), (s) => {
                document.getElementById('withdrawal-requests').innerHTML = s.docs.map(d => `
                    <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700">
                        <p class="text-xs text-gray-400">Par: ${d.data().userName}</p>
                        <p class="text-lg font-bold text-orange-400">${d.data().netAmount.toFixed(2)} DOGE</p>
                        <p class="text-[10px] break-all text-gray-500">${d.data().address}</p>
                        <div class="flex gap-2 mt-4">
                            <button onclick="handleAdminW('${d.id}', 'Valider')" class="flex-1 bg-green-600 py-2 rounded-xl text-xs font-bold">APPROUVER</button>
                            <button onclick="handleAdminW('${d.id}', 'Refuser')" class="flex-1 bg-red-600 py-2 rounded-xl text-xs font-bold">REJETER</button>
                        </div>
                    </div>`).join('');
            });
        };

        window.handleAdminW = async (id, action) => {
            if (action === 'Valider') await updateDoc(doc(db, "withdrawals", id), { status: 'pay√©' });
            else {
                const s = await getDoc(doc(db, "withdrawals", id));
                await updateDoc(doc(db, "users", s.data().userId), { balance: increment(s.data().amountRequested) });
                await updateDoc(doc(db, "withdrawals", id), { status: 'rejet√©' });
            }
        };

        window.copyReferral = () => { 
            navigator.clipboard.writeText(userData.myCode); 
            Swal.fire({ toast: true, position: 'top', icon: 'success', title: 'Code copi√© !', showConfirmButton: false, timer: 2000 }); 
        };
    </script>
</body>
</html>

