import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  updateDoc, 
  serverTimestamp, 
  increment 
} from 'firebase/firestore';
import { 
  Zap, 
  TrendingUp, 
  LogOut, 
  Coins, 
  Loader2,
  ShieldCheck,
  Smartphone,
  ArrowRight
} from 'lucide-react';

// Configuration Firebase
const firebaseConfig = JSON.parse(__firebase_config);
const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'farm-empire-turbo';

// Configuration Maketou
const MAKETOU_KEY = 'msk_35395609d94589dfe55e846950480c47fb9f44af58f590faf6ab2bbe0a0c2014';
const PRODUCT_ID = '0bdd242d-3ae3-4640-816e-97a5e731796b';

export default function App() {
  const [user, setUser] = useState(null);
  const [authUser, setAuthUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [view, setView] = useState('dashboard');

  // --- INITIALISATION MOBILE & AUTH ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };

    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
      setAuthUser(firebaseUser);
      if (firebaseUser) {
        const savedId = localStorage.getItem('fe_turbo_uid');
        if (savedId) {
          startUserSync(savedId);
        } else {
          setLoading(false);
        }
      }
    });

    return () => unsubscribe();
  }, []);

  // --- GESTION RETOUR PAIEMENT ---
  useEffect(() => {
    if (authUser) {
      const params = new URLSearchParams(window.location.search);
      const cartId = params.get('cartId');
      const savedId = localStorage.getItem('fe_turbo_uid');

      if (cartId && savedId) {
        setView('pending');
        verifyPayment(cartId, savedId);
      }
    }
  }, [authUser]);

  const startUserSync = (uid) => {
    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
    return onSnapshot(userRef, (snap) => {
      if (snap.exists()) {
        setUser({ id: snap.id, ...snap.data() });
      }
      setLoading(false);
    }, () => setLoading(false));
  };

  const verifyPayment = async (cartId, uid) => {
    try {
      const response = await fetch(`https://api.maketou.net/api/v1/stores/cart/${cartId}`, {
        headers: { 'Authorization': `Bearer ${MAKETOU_KEY}` }
      });
      const data = await response.json();

      if (data.status === 'completed' || data.status === 'success') {
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
        await updateDoc(userRef, {
          isWorkerActive: true,
          activatedAt: serverTimestamp(),
          balance: increment(5.0)
        });
      }
    } catch (e) { console.error(e); }
    window.history.replaceState({}, document.title, window.location.pathname);
    setView('dashboard');
  };

  const handleAuth = async (e) => {
    e.preventDefault();
    if (!authUser || isProcessing) return;

    setIsProcessing(true);
    const cleanEmail = email.toLowerCase().trim();
    const uid = btoa(cleanEmail).replace(/[^a-zA-Z0-9]/g, '');

    try {
      const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        const userData = {
          email: cleanEmail,
          password: password,
          name: cleanEmail.split('@')[0],
          balance: 0,
          isWorkerActive: false,
          createdAt: serverTimestamp()
        };
        await setDoc(userRef, userData);
        setUser({ id: uid, ...userData });
      } else {
        if (snap.data().password !== password) {
          alert("Mot de passe incorrect");
          setIsProcessing(false);
          return;
        }
        setUser({ id: uid, ...snap.data() });
      }

      localStorage.setItem('fe_turbo_uid', uid);
      startUserSync(uid);
    } catch (err) {
      alert("Erreur de connexion. Vérifiez votre réseau.");
    } finally {
      setIsProcessing(false);
    }
  };

  const handlePayment = async () => {
    if (!user || isProcessing) return;
    setIsProcessing(true);
    try {
      const response = await fetch('https://api.maketou.net/api/v1/stores/cart/checkout', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${MAKETOU_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          productDocumentId: PRODUCT_ID,
          email: user.email,
          firstName: user.name,
          lastName: "User",
          redirectURL: window.location.href
        })
      });

      const data = await response.json();
      if (data.redirectUrl) {
        window.location.href = data.redirectUrl;
      } else {
        alert("Erreur Maketou. Réessayez.");
      }
    } catch (e) {
      alert("Erreur de liaison paiement.");
    } finally {
      setIsProcessing(false);
    }
  };

  if (loading) return (
    <div className="min-h-screen bg-[#0a0a0c] flex items-center justify-center">
      <Loader2 className="animate-spin text-yellow-500 h-12 w-12" />
    </div>
  );

  if (!user) return (
    <div className="min-h-screen bg-[#0a0a0c] text-white p-6 flex flex-col items-center justify-center">
      <div className="w-full max-w-sm space-y-8">
        <div className="text-center">
          <div className="bg-yellow-500 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-yellow-500/20 rotate-3">
            <Zap className="text-black h-8 w-8" fill="currentColor" />
          </div>
          <h1 className="text-3xl font-black tracking-tighter italic uppercase">Farm Empire</h1>
          <p className="text-slate-500 text-sm mt-1">Élevage crypto sécurisé au Gabon</p>
        </div>

        <form onSubmit={handleAuth} className="space-y-4">
          <div className="space-y-2">
            <input 
              type="email" 
              placeholder="Email" 
              className="w-full bg-[#16161a] border border-white/5 p-5 rounded-2xl outline-none focus:border-yellow-500/50 text-base"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
            <input 
              type="password" 
              placeholder="Mot de passe" 
              className="w-full bg-[#16161a] border border-white/5 p-5 rounded-2xl outline-none focus:border-yellow-500/50 text-base"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
          </div>
          
          <button 
            disabled={isProcessing || !authUser}
            className="w-full bg-yellow-500 disabled:opacity-50 text-black font-black py-5 rounded-2xl text-lg flex items-center justify-center gap-3 active:scale-95 transition-transform"
          >
            {isProcessing ? <Loader2 className="animate-spin" /> : "ACCÉDER À L'ENCLOS"}
            {!isProcessing && <ArrowRight size={20} />}
          </button>
          
          <div className="flex items-center justify-center gap-2 text-[10px] text-slate-500 font-bold uppercase tracking-widest">
            <ShieldCheck size={14} className="text-green-500" />
            Liaison Firebase Chiffrée
          </div>
        </form>
      </div>
    </div>
  );

  if (view === 'pending') return (
    <div className="min-h-screen bg-[#0a0a0c] flex flex-col items-center justify-center text-white p-6 text-center">
      <div className="relative">
        <div className="h-24 w-24 border-4 border-yellow-500/20 border-t-yellow-500 rounded-full animate-spin"></div>
        <Coins className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-yellow-500 h-8 w-8" />
      </div>
      <h2 className="text-xl font-black mt-8">Validation Maketou...</h2>
      <p className="text-slate-500 text-sm mt-2">Nous sécurisons votre achat sur la blockchain.</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#0a0a0c] text-white flex flex-col">
      <header className="p-5 flex justify-between items-center bg-[#0a0a0c]/80 backdrop-blur-md sticky top-0 z-50 border-b border-white/5">
        <div className="flex items-center gap-2">
          <Zap className="text-yellow-500" size={18} fill="currentColor" />
          <span className="font-black text-sm uppercase tracking-tighter">Empire</span>
        </div>
        <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="text-slate-500 p-2"><LogOut size={20} /></button>
      </header>

      <main className="p-5 space-y-6 flex-1 max-w-md mx-auto w-full">
        {/* Wallet Card */}
        <div className="bg-gradient-to-tr from-[#1a1a1e] to-[#25252b] p-6 rounded-[2rem] border border-white/5 shadow-2xl relative overflow-hidden">
          <div className="relative z-10">
            <div className="flex justify-between items-start mb-6">
              <span className="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em]">Compte de Minage</span>
              <Smartphone size={16} className="text-slate-700" />
            </div>
            <div className="flex items-baseline gap-2">
              <h2 className="text-5xl font-black tracking-tighter">{user.balance?.toFixed(2) || "0.00"}</h2>
              <span className="text-yellow-500 font-bold text-sm">DOGE</span>
            </div>
            <div className="mt-8 flex gap-2">
              <button className="flex-1 bg-white/5 py-3 rounded-xl font-bold text-xs">HISTORIQUE</button>
              <button className="flex-1 bg-yellow-500 text-black py-3 rounded-xl font-black text-xs">RETIRER</button>
            </div>
          </div>
          <Coins size={100} className="absolute -right-6 -bottom-6 opacity-5 rotate-12" />
        </div>

        {/* Status */}
        {!user.isWorkerActive ? (
          <div className="bg-yellow-500/5 border border-yellow-500/20 p-6 rounded-[2rem] text-center">
            <h3 className="text-lg font-black text-yellow-500 mb-2 underline decoration-2 underline-offset-4">ENCLOS INACTIF</h3>
            <p className="text-slate-400 text-xs mb-6 px-4 leading-relaxed font-medium">
              Votre mineur est en attente. Activez votre licence pour commencer à produire.
            </p>
            <button 
              onClick={handlePayment}
              disabled={isProcessing}
              className="w-full bg-white text-black py-5 rounded-2xl font-black flex justify-between items-center px-6 active:scale-[0.98] transition-all shadow-xl shadow-white/5"
            >
              {isProcessing ? <Loader2 className="animate-spin mx-auto" size={20} /> : (
                <>
                  <span className="text-sm">ACTIVER LE PACK</span>
                  <span className="bg-black/5 px-2 py-1 rounded text-[10px] border border-black/10">2000 FCFA</span>
                </>
              )}
            </button>
          </div>
        ) : (
          <div className="bg-green-500/5 border border-green-500/20 p-6 rounded-[2rem] flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="w-10 h-10 bg-green-500/10 text-green-500 rounded-full flex items-center justify-center animate-pulse">
                <TrendingUp size={20} />
              </div>
              <div>
                <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Minage en cours</p>
                <h4 className="font-black text-green-500">+2.5 DOGE / JOUR</h4>
              </div>
            </div>
          </div>
        )}
      </main>
      
      <footer className="p-6 text-center">
        <p className="text-[9px] text-slate-700 font-bold uppercase tracking-[0.3em]">Gabon • Maketou • Blockchain</p>
      </footer>
    </div>
  );
}

